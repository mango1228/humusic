<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#06060C">
<title>Humusic</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#06060C;color:#eee;font-family:-apple-system,sans-serif;max-width:420px;margin:0 auto;min-height:100vh;overflow-x:hidden}
button{border:none;background:none;color:#eee;font-family:inherit;cursor:pointer;-webkit-tap-highlight-color:transparent}
.screen{display:none;padding:20px;padding-top:50px;min-height:100vh}
.screen.active{display:block}
.gradient{background:linear-gradient(135deg,#FF6B4A,#FF3CAC,#845EF7)}
.btn{padding:14px 36px;border-radius:99px;font-size:15px;font-weight:700;color:#fff}
.card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:14px;margin-bottom:10px}
.dim{color:rgba(255,255,255,0.4)}
.muted{color:rgba(255,255,255,0.2)}
.nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:420px;background:rgba(6,6,12,0.95);border-top:1px solid rgba(255,255,255,0.06);display:flex;justify-content:space-around;padding:10px 0 16px;z-index:100}
.nav button{font-size:10px;display:flex;flex-direction:column;align-items:center;gap:4px}
.rec-btn{width:72px;height:72px;border-radius:50%;border:3px solid rgba(255,107,74,0.4);background:rgba(255,255,255,0.95);display:flex;align-items:center;justify-content:center}
.rec-btn .dot{width:32px;height:32px;border-radius:50%;background:#e74c3c}
.rec-btn .stop{width:22px;height:22px;border-radius:4px;background:#fff}
canvas{width:100%;height:100px;display:block}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
h1{font-size:28px;font-weight:900;background:linear-gradient(135deg,#FF6B4A,#FF3CAC,#845EF7);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.google-btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:14px 32px;border-radius:99px;font-size:15px;font-weight:600;background:#fff;color:#333;box-shadow:0 4px 16px rgba(0,0,0,0.3)}
.user-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.user-info{display:flex;align-items:center;gap:10px}
.user-avatar{width:32px;height:32px;border-radius:50%;border:2px solid rgba(255,107,74,0.3)}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="s-login" class="screen active">
<div style="text-align:center;padding-top:25vh">
<div style="font-size:64px;margin-bottom:20px">ğŸ¤</div>
<h1 style="font-size:32px;margin-bottom:8px">Humusic</h1>
<p class="dim" style="font-size:14px;margin-bottom:40px;line-height:1.6">ë…¹ìŒí•˜ë©´ AIê°€<br>ìŒì•…ìœ¼ë¡œ ë§Œë“¤ì–´ë“œë ¤ìš”</p>
<div id="inapp-warn" style="display:none;background:rgba(255,107,74,0.1);border:1px solid rgba(255,107,74,0.2);border-radius:14px;padding:16px;margin-bottom:20px;text-align:left">
<p style="font-size:14px;font-weight:700;margin-bottom:6px">ì™¸ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ì–´ì£¼ì„¸ìš”</p>
<p class="dim" style="font-size:12px;line-height:1.6;margin-bottom:10px">ì¹´ì¹´ì˜¤í†¡Â·ì¸ìŠ¤íƒ€ê·¸ë¨ ë“± ì¸ì•± ë¸Œë¼ìš°ì €ì—ì„œëŠ”<br>Google ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ë¡œê·¸ì¸ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.</p>
<button onclick="openExternal()" style="width:100%;padding:12px;border-radius:10px;font-size:14px;font-weight:700;color:#fff;margin-bottom:8px" class="gradient">Chrome/Safarië¡œ ì—´ê¸°</button>
<button onclick="copyLink()" id="copy-btn" style="width:100%;padding:10px;border-radius:10px;font-size:13px;color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1)">ë§í¬ ë³µì‚¬í•˜ê¸°</button>
</div>
<button class="google-btn" onclick="signIn()">
<svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
Googleë¡œ ì‹œì‘í•˜ê¸°
</button>
</div>
</div>

<!-- HOME -->
<div id="s-home" class="screen">
<div class="user-bar">
<div>
<p class="muted" style="font-size:11px;letter-spacing:2px;margin-bottom:4px">YOUR MUSIC STUDIO</p>
<h1>Humusic</h1>
</div>
<div class="user-info">
<img id="user-avatar" class="user-avatar" src="" alt="">
<button class="dim" style="font-size:11px" onclick="signOut()">ë¡œê·¸ì•„ì›ƒ</button>
</div>
</div>
<div style="text-align:center;padding:30px 0;border-radius:20px;margin-top:8px;background:linear-gradient(160deg,rgba(255,107,74,0.1),rgba(132,94,247,0.05));border:1px solid rgba(255,107,74,0.1)">
<div style="font-size:48px;margin-bottom:12px">ğŸ¤</div>
<h2 style="font-size:18px;font-weight:700;line-height:1.5;margin-bottom:6px">í¥ì–¼ê±°ë¦¼ì„<br>ìŒì•…ìœ¼ë¡œ ë§Œë“¤ì–´ë³´ì„¸ìš”</h2>
<p class="dim" style="font-size:13px;margin-bottom:20px">ë…¹ìŒí•˜ë©´ AIê°€<br>ì™„ì„±ëœ ê³¡ìœ¼ë¡œ ë§Œë“¤ì–´ë“œë ¤ìš”</p>
<button class="btn gradient" onclick="goRecord()" style="box-shadow:0 6px 24px rgba(255,107,74,0.3)">ë…¹ìŒ ì‹œì‘í•˜ê¸°</button>
</div>
<div style="height:120px"></div>
</div>

<!-- RECORDING -->
<div id="s-record" class="screen">
<div style="display:flex;justify-content:space-between;align-items:center">
<button class="dim" onclick="goHome()">â† ë’¤ë¡œ</button>
<span class="muted" style="font-size:12px;letter-spacing:1px">ë…¹ìŒ</span>
<div style="width:40px"></div>
</div>
<div style="text-align:center;margin-top:20px">
<div id="timer" style="font-size:48px;font-weight:300;letter-spacing:6px">0:00</div>
<div id="rec-status" class="muted" style="font-size:12px;margin-top:6px">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”</div>
</div>
<div class="card" style="margin-top:16px;padding:14px;background:rgba(255,107,74,0.05)">
<p class="muted" style="font-size:11px;letter-spacing:1px;margin-bottom:8px">ğŸ¨ ìŠ¤íƒ€ì¼ (ì„ íƒì‚¬í•­)</p>
<input id="prompt-input" type="text" placeholder="ì˜ˆ: ì‹ ë‚˜ëŠ” íŒì†¡, ìŠ¬í”ˆ ë°œë¼ë“œ, ê°•ë ¬í•œ ë¡..." style="width:100%;padding:12px 14px;border-radius:10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#fff;font-size:14px;outline:none;font-family:inherit;box-sizing:border-box" maxlength="200">
<p class="dim" style="font-size:11px;margin-top:6px;line-height:1.5">ë¹„ì›Œë‘ë©´ AIê°€ ìë™ìœ¼ë¡œ ê²°ì •í•´ìš”</p>
</div>
<div class="card" style="margin-top:16px;padding:16px"><canvas id="wave"></canvas></div>
<div style="display:flex;justify-content:center;margin-top:12px">
<div id="mode-toggle" style="display:inline-flex;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:99px;padding:3px;gap:2px">
<button id="mode-vocal" onclick="setInstrumental(false)" style="padding:8px 16px;border-radius:99px;font-size:12px;font-weight:600;color:#fff;transition:all .2s" class="gradient">ê°€ì‚¬ í¬í•¨</button>
<button id="mode-inst" onclick="setInstrumental(true)" style="padding:8px 16px;border-radius:99px;font-size:12px;font-weight:600;color:rgba(255,255,255,0.35);background:transparent;transition:all .2s">ì—°ì£¼ê³¡</button>
</div>
</div>
<div style="display:flex;justify-content:center;align-items:center;gap:24px;padding:20px 0">
<button id="btn-reset" onclick="resetRec()" style="display:none;width:48px;height:48px;border-radius:50%;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);font-size:20px">â†º</button>
<button id="btn-rec" class="rec-btn" onclick="toggleRec()"><div class="dot"></div></button>
</div>
<button id="btn-next" onclick="submitGen()" class="btn gradient" style="display:none;width:100%;margin-top:8px;font-size:16px;box-shadow:0 6px 24px rgba(255,107,74,0.3)">ì´ ë…¹ìŒìœ¼ë¡œ ê³¡ ë§Œë“¤ê¸°</button>
</div>

<!-- GENERATING -->
<div id="s-gen" class="screen" style="text-align:center;padding-top:30vh">
<div style="width:80px;height:80px;border-radius:50%;border:3px solid rgba(255,255,255,0.06);border-top-color:#FF6B4A;animation:spin 1s linear infinite;margin:0 auto 24px"></div>
<h2 style="font-size:18px;font-weight:700;margin-bottom:8px">AIê°€ ê³¡ì„ ë§Œë“¤ê³  ìˆì–´ìš”</h2>
<p id="gen-style" class="dim" style="font-size:13px;margin-bottom:6px"></p>
<p id="gen-msg" style="color:#FF6B4A;font-size:12px;animation:pulse 2s infinite;margin-bottom:16px"></p>
<div style="width:240px;height:5px;border-radius:99px;background:rgba(255,255,255,0.03);margin:0 auto;overflow:hidden">
<div id="gen-bar" style="width:0%;height:100%;border-radius:99px;transition:width .3s" class="gradient"></div>
</div>
<span id="gen-pct" class="muted" style="font-size:12px;margin-top:8px;display:block">0%</span>
<p class="dim" style="font-size:11px;margin-top:20px;line-height:1.6">ë³´í†µ 1~3ë¶„ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤<br>ë‹¤ë¥¸ í™”ë©´ì„ ë‘˜ëŸ¬ë³´ì…”ë„ ë©ë‹ˆë‹¤</p>
<div style="height:80px"></div>
</div>

<!-- ERROR -->
<div id="s-error" class="screen" style="text-align:center;padding-top:25vh">
<div style="font-size:56px;margin-bottom:16px">ğŸ˜”</div>
<h2 style="font-size:18px;font-weight:700;margin-bottom:8px">ê³¡ ìƒì„±ì— ì‹¤íŒ¨í–ˆì–´ìš”</h2>
<p id="error-msg" class="dim" style="font-size:13px;line-height:1.6;margin-bottom:24px"></p>
<button class="btn gradient" onclick="goRecord()" style="box-shadow:0 6px 24px rgba(255,107,74,0.3)">ë‹¤ì‹œ ë…¹ìŒí•˜ê¸°</button>
<button class="dim" onclick="goHome()" style="display:block;margin:12px auto;font-size:13px">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<!-- RESULT -->
<div id="s-result" class="screen">
<div style="display:flex;justify-content:space-between;align-items:center">
<button id="result-back" class="dim" onclick="goHome()">â† í™ˆ</button>
<span class="muted" style="font-size:12px;letter-spacing:1px">ì™„ì„±</span>
<div style="width:40px"></div>
</div>
<div style="text-align:center;margin-top:16px">
<div id="album-art" style="width:200px;height:200px;border-radius:20px;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;font-size:56px;box-shadow:0 12px 40px rgba(255,60,172,0.15)" class="gradient">ğŸ¶</div>
<h2 id="song-title" style="font-size:20px;font-weight:700"></h2>
<p id="song-info" class="dim" style="font-size:13px;margin-top:4px"></p>
</div>
<div id="custom-player" style="display:none;margin-top:20px">
<div style="display:flex;align-items:center;gap:14px">
<button id="cp-play" onclick="togglePlay()" style="width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;color:#fff;border:none" class="gradient"><span id="cp-icon">â–¶</span></button>
<div style="flex:1;min-width:0">
<div id="cp-bar-wrap" style="width:100%;height:6px;border-radius:3px;background:rgba(255,255,255,0.06);cursor:pointer;position:relative" onclick="seekAudio(event)">
<div id="cp-progress" style="width:0%;height:100%;border-radius:3px;pointer-events:none" class="gradient"></div>
</div>
<div style="display:flex;justify-content:space-between;margin-top:6px">
<span id="cp-cur" class="muted" style="font-size:11px">0:00</span>
<span id="cp-dur" class="muted" style="font-size:11px">0:00</span>
</div>
</div>
</div>
</div>
<audio id="player"></audio>
<div id="no-audio" class="dim" style="text-align:center;font-size:12px;display:none;margin-top:16px">ì˜¤ë””ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
<div id="lyrics-box" style="margin-top:20px;display:none">
<p class="muted" style="font-size:11px;letter-spacing:1.5px;margin-bottom:8px">ê°€ì‚¬</p>
<div class="card"><p id="lyrics" style="color:rgba(255,255,255,0.55);font-size:13px;line-height:2;white-space:pre-line;font-style:italic"></p></div>
</div>
<div id="rec-player" style="display:none;margin-top:20px">
<p class="muted" style="font-size:11px;letter-spacing:1.5px;margin-bottom:8px">ë‚´ ë…¹ìŒ ì›ë³¸</p>
<div class="card" style="display:flex;align-items:center;gap:12px;padding:12px 14px">
<button id="rp-play" onclick="toggleRecPlay()" style="width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;color:#fff;border:none;background:rgba(255,255,255,0.08)"><span id="rp-icon">â–¶</span></button>
<div style="flex:1;min-width:0">
<div id="rp-bar-wrap" style="width:100%;height:4px;border-radius:2px;background:rgba(255,255,255,0.06);cursor:pointer" onclick="seekRecAudio(event)">
<div id="rp-progress" style="width:0%;height:100%;border-radius:2px;background:rgba(255,255,255,0.25);pointer-events:none"></div>
</div>
<div style="display:flex;justify-content:space-between;margin-top:4px">
<span id="rp-cur" class="muted" style="font-size:10px">0:00</span>
<span id="rp-dur" class="muted" style="font-size:10px">0:00</span>
</div>
</div>
</div>
</div>
<audio id="rec-audio"></audio>
<div style="height:120px"></div>
</div>

<!-- LIBRARY -->
<div id="s-library" class="screen">
<h1 style="font-size:24px">ë‚´ ë³´ê´€í•¨</h1>
<p class="dim" style="font-size:13px;margin-top:4px" id="lib-count">0ê³¡</p>
<div id="lib-list" style="margin-top:16px"></div>
<div id="lib-empty" style="text-align:center;padding:60px 0">
<div style="font-size:48px;margin-bottom:12px">ğŸµ</div>
<p class="dim">ì•„ì§ ë§Œë“  ê³¡ì´ ì—†ì–´ìš”</p>
<button class="btn gradient" onclick="goRecord()" style="margin-top:16px">ì²« ê³¡ ë§Œë“¤ëŸ¬ ê°€ê¸°</button>
</div>
<div style="height:120px"></div>
</div>

<!-- POPOVER -->
<div id="popover-bg" onclick="closePopover()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:200"></div>
<div id="popover" style="display:none;position:fixed;z-index:201;background:rgba(40,40,50,0.98);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:4px;min-width:140px;box-shadow:0 8px 32px rgba(0,0,0,0.5);backdrop-filter:blur(12px)">
<button onclick="doRename()" style="width:100%;padding:12px 16px;text-align:left;font-size:14px;color:rgba(255,255,255,0.85);border-radius:8px;background:transparent">ì´ë¦„ ë°”ê¾¸ê¸°</button>
<button onclick="doDelete()" style="width:100%;padding:12px 16px;text-align:left;font-size:14px;color:#ff4d4f;border-radius:8px;background:transparent">ì‚­ì œí•˜ê¸°</button>
</div>
<div id="rename-bg" onclick="closeRename()" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:300"></div>
<div id="rename-modal" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:301;background:rgba(40,40,50,0.98);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:20px;width:calc(100% - 48px);max-width:320px;box-shadow:0 12px 40px rgba(0,0,0,0.6);backdrop-filter:blur(12px)">
<p style="font-size:15px;font-weight:600;margin-bottom:12px">ì´ë¦„ ë°”ê¾¸ê¸°</p>
<input id="rename-input" type="text" onkeydown="if(event.key==='Enter')submitRename()" style="width:100%;padding:12px;border-radius:10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#fff;font-size:14px;outline:none;box-sizing:border-box" maxlength="50">
<div style="display:flex;gap:8px;margin-top:14px">
<button onclick="closeRename()" style="flex:1;padding:10px;border-radius:10px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.5);font-size:14px">ì·¨ì†Œ</button>
<button onclick="submitRename()" class="gradient" style="flex:1;padding:10px;border-radius:10px;color:#fff;font-size:14px;font-weight:600">í™•ì¸</button>
</div>
</div>

<!-- MINI PLAYER -->
<div id="mini-player" style="display:none;position:fixed;bottom:56px;left:50%;transform:translateX(-50%);width:100%;max-width:420px;z-index:101;padding:0 8px">
<div onclick="showResult(G.currentSong)" style="background:rgba(30,30,40,0.97);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:8px 12px;display:flex;align-items:center;gap:10px;cursor:pointer;backdrop-filter:blur(12px)">
<div id="mini-thumb" style="width:36px;height:36px;border-radius:8px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:14px" class="gradient">ğŸ¶</div>
<div style="flex:1;min-width:0;display:flex;flex-direction:column;gap:2px">
<b id="mini-title" style="font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:block"></b>
<div style="width:100%;height:3px;border-radius:2px;background:rgba(255,255,255,0.06)"><div id="mini-progress" style="width:0%;height:100%;border-radius:2px;transition:width .3s" class="gradient"></div></div>
</div>
<button onclick="event.stopPropagation();togglePlay()" style="width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;background:rgba(255,255,255,0.08);flex-shrink:0"><span id="mini-play-icon">â–¶</span></button>
</div>
</div>

<!-- NAV -->
<div class="nav" id="navbar" style="display:none">
<button id="nav-home" onclick="goHome()"><span>ğŸ </span><span>í™ˆ</span></button>
<button id="nav-gen" onclick="show('s-gen')" style="display:none;position:relative"><span style="animation:spin 2s linear infinite;display:inline-block">â³</span><span style="color:#FF6B4A">ìƒì„± ì¤‘</span></button>
<button onclick="goLib()"><span>ğŸµ</span><span>ë³´ê´€í•¨</span></button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Supabase ì´ˆê¸°í™”
var SUPABASE_URL='https://xjuzejvrzhzwjcwcmgmv.supabase.co';
var SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqdXplanZyemh6d2pjd2NtZ212Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MzkyOTcsImV4cCI6MjA4NjUxNTI5N30.cMJGmuIZ7_LsBvHcmqxOmkWoPx1jCrAp4_W4CYg8_uE';
var sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

var G={recording:false,simMode:false,time:0,songs:[],user:null,currentSong:null,instrumental:false},
mediaRec,audioCtx,analyser,stream,chunks=[],timerIv,canvasAnim;

async function getAuthHeaders(){
var {data}=await sb.auth.getSession();
var token=data&&data.session?data.session.access_token:'';
return {'Content-Type':'application/json','Authorization':'Bearer '+token};
}

// === ì¸ì¦ ===
async function signIn(){
sb.auth.signInWithOAuth({provider:'google',options:{redirectTo:window.location.origin}});
}

async function signOut(){
await sb.auth.signOut();
G.user=null;G.songs=[];
show('s-login');
document.getElementById('navbar').style.display='none';
}

async function checkAuth(){
var {data:{session}}=await sb.auth.getSession();
if(session&&session.user){
G.user=session.user;
showLoggedIn();
}else{
show('s-login');
document.getElementById('navbar').style.display='none';
}
}

function showLoggedIn(){
var avatar=G.user.user_metadata.avatar_url||'';
if(avatar)document.getElementById('user-avatar').src=avatar;
document.getElementById('user-avatar').style.display=avatar?'block':'none';
if(!resumeGenIfNeeded()){goHome();}
}

sb.auth.onAuthStateChange(function(event,session){
if(event==='SIGNED_IN'&&session){G.user=session.user;showLoggedIn();}
if(event==='SIGNED_OUT'){G.user=null;show('s-login');document.getElementById('navbar').style.display='none';}
});

// === ë„¤ë¹„ê²Œì´ì…˜ ===
var _genActive=false,_pollIv=null,_submitting=false;
function show(id){document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active')});document.getElementById(id).classList.add('active');var showNav=id==='s-home'||id==='s-library'||id==='s-gen';document.getElementById('navbar').style.display=showNav?'flex':'none';document.getElementById('nav-gen').style.display=_genActive&&id!=='s-gen'?'flex':'none';document.getElementById('nav-home').style.display=_genActive?'none':'flex';var hasSong=G.currentSong&&G.currentSong.audioUrl;document.getElementById('mini-player').style.display=(hasSong&&id!=='s-result'&&showNav)?'block':'none';}
function fmtT(s){s=Math.floor(s);return Math.floor(s/60)+':'+String(s%60).padStart(2,'0');}
function goHome(){show('s-home');}
function goRecord(){G.time=0;G.simMode=false;G.instrumental=false;show('s-record');updateRecUI();updateModeToggle();}
function goLib(){show('s-library');loadLibrary();}
function setInstrumental(v){G.instrumental=v;updateModeToggle();}
function updateModeToggle(){var vb=document.getElementById('mode-vocal'),ib=document.getElementById('mode-inst');if(G.instrumental){vb.className='';vb.style.background='transparent';vb.style.color='rgba(255,255,255,0.35)';ib.className='gradient';ib.style.color='#fff';}else{vb.className='gradient';vb.style.color='#fff';ib.className='';ib.style.background='transparent';ib.style.color='rgba(255,255,255,0.35)';}}

// === ë…¹ìŒ UI ===
function updateRecUI(){
document.getElementById('timer').textContent=fmtT(G.time);
document.getElementById('rec-status').textContent=G.recording?'â— ë…¹ìŒ ì¤‘...':G.time>0?'ë…¹ìŒ ì™„ë£Œ':'ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”';
document.getElementById('rec-status').style.color=G.recording?'#FF6B4A':'rgba(255,255,255,0.2)';
document.getElementById('btn-reset').style.display=G.time>0&&!G.recording?'block':'none';
document.getElementById('btn-next').style.display=G.time>=3&&!G.recording?'block':'none';
var b=document.getElementById('btn-rec');
b.style.background=G.recording?'rgba(231,76,60,0.9)':'';
b.className='rec-btn';
b.innerHTML=G.recording?'<div class="stop"></div>':'<div class="dot"></div>';
}

function resetRec(){G.time=0;G.simMode=false;updateRecUI();}

async function toggleRec(){
if(G.recording){clearInterval(timerIv);G.recording=false;
if(!G.simMode&&mediaRec&&mediaRec.state!=='inactive')mediaRec.stop();
if(stream)stream.getTracks().forEach(function(t){t.stop()});
if(audioCtx)audioCtx.close().catch(function(){});
updateRecUI();return;}
try{
stream=await navigator.mediaDevices.getUserMedia({audio:true});
audioCtx=new(window.AudioContext||window.webkitAudioContext)();
var src=audioCtx.createMediaStreamSource(stream);
analyser=audioCtx.createAnalyser();analyser.fftSize=512;src.connect(analyser);
mediaRec=new MediaRecorder(stream);chunks=[];
mediaRec.ondataavailable=function(e){if(e.data.size>0)chunks.push(e.data);};
mediaRec.start(100);G.simMode=false;
}catch(e){G.simMode=true;}
G.recording=true;G.time=0;
timerIv=setInterval(function(){G.time++;updateRecUI();},1000);
updateRecUI();drawWave();
}

function drawWave(){
var c=document.getElementById('wave');if(!c)return;
var ctx=c.getContext('2d'),dpr=window.devicePixelRatio||1;
c.width=c.offsetWidth*dpr;c.height=c.offsetHeight*dpr;ctx.scale(dpr,dpr);
var W=c.offsetWidth,H=c.offsetHeight,bars=40,bw=3,gap=(W-bars*bw)/(bars-1),data=new Uint8Array(256),t=0;
cancelAnimationFrame(canvasAnim);
function draw(){ctx.clearRect(0,0,W,H);
if(analyser&&G.recording&&!G.simMode){analyser.getByteFrequencyData(data);}
t+=.06;
for(var i=0;i<bars;i++){var v;
if(G.simMode&&G.recording){v=.2+.4*Math.sin(t+i*.3)*Math.sin(t*.7+i*.15)+.15*Math.cos(t*1.3+i*.5);v=Math.max(.05,Math.min(1,v));}
else if(analyser&&G.recording){v=data[Math.floor(i*200/bars)]/255;}else{v=0;}
var h=Math.max(3,v*H*.85),x=i*(bw+gap),y=(H-h)/2;
var g=ctx.createLinearGradient(x,y,x,y+h);
g.addColorStop(0,'rgba(255,107,74,'+(0.3+v*0.7)+')');
g.addColorStop(1,'rgba(132,94,247,'+(0.3+v*0.7)+')');
ctx.fillStyle=g;ctx.beginPath();ctx.roundRect(x,y,bw,h,2);ctx.fill();}
canvasAnim=requestAnimationFrame(draw);}draw();
}

// === WebM â†’ WAV ë³€í™˜ ===
function convertToWav(blob){
return new Promise(function(resolve,reject){
var actx=new(window.AudioContext||window.webkitAudioContext)();
var reader=new FileReader();
reader.onloadend=function(){
actx.decodeAudioData(reader.result,function(buf){
var numCh=buf.numberOfChannels,rate=buf.sampleRate,len=buf.length;
var wavBuf=new ArrayBuffer(44+len*numCh*2);
var view=new DataView(wavBuf);
function writeStr(o,s){for(var i=0;i<s.length;i++)view.setUint8(o+i,s.charCodeAt(i));}
writeStr(0,'RIFF');view.setUint32(4,36+len*numCh*2,true);writeStr(8,'WAVE');
writeStr(12,'fmt ');view.setUint32(16,16,true);view.setUint16(20,1,true);
view.setUint16(22,numCh,true);view.setUint32(24,rate,true);
view.setUint32(28,rate*numCh*2,true);view.setUint16(32,numCh*2,true);
view.setUint16(34,16,true);writeStr(36,'data');view.setUint32(40,len*numCh*2,true);
var off=44;
for(var i=0;i<len;i++){for(var ch=0;ch<numCh;ch++){
var s=Math.max(-1,Math.min(1,buf.getChannelData(ch)[i]));
view.setInt16(off,s<0?s*0x8000:s*0x7FFF,true);off+=2;}}
actx.close();
resolve(new Blob([wavBuf],{type:'audio/wav'}));
},function(e){actx.close();reject(e);});
};
reader.onerror=reject;
reader.readAsArrayBuffer(blob);
});
}

// === ê³¡ ìƒì„± ===
async function submitGen(){
if(G.time<3||_submitting)return;
_submitting=true;_maxP=0;
show('s-gen');
document.getElementById('gen-style').textContent='ë©œë¡œë”” ê¸°ë°˜ AI ìë™ ì‘ê³¡';
document.getElementById('gen-bar').style.width='0%';
document.getElementById('gen-pct').textContent='0%';

// ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ (ë§ˆì´í¬ ì—†ìŒ) â†’ ì—ëŸ¬
if(G.simMode||chunks.length===0){
showError('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ì ‘ê·¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
return;
}

var taskId=null;

// Step 1: WebM â†’ WAV ë³€í™˜ í›„ ì—…ë¡œë“œ
setProgress(5,'ì˜¤ë””ì˜¤ë¥¼ ë³€í™˜í•˜ê³  ìˆì–´ìš”...');
try{
var webmBlob=new Blob(chunks,{type:'audio/webm'});
var wavBlob=await convertToWav(webmBlob);
setProgress(8,'ë…¹ìŒëœ ì˜¤ë””ì˜¤ë¥¼ ì—…ë¡œë“œ ì¤‘...');
var base64=await new Promise(function(resolve,reject){
var reader=new FileReader();
reader.onloadend=function(){resolve(reader.result.split(',')[1]);};
reader.onerror=reject;
reader.readAsDataURL(wavBlob);
});

var authHeaders=await getAuthHeaders();
var uploadRes=await fetch('/api/upload-audio',{method:'POST',headers:authHeaders,body:JSON.stringify({audioBase64:base64})});
var uploadData=await uploadRes.json();

if(!uploadData.success||!uploadData.blobUrl){
console.log('Upload failed:',uploadData);
showError('ì˜¤ë””ì˜¤ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
return;
}

// Step 2: sunoapi.org upload-extend
setProgress(15,'AIì—ê²Œ ê³¡ ìƒì„±ì„ ìš”ì²­ ì¤‘...');
var prompt=document.getElementById('prompt-input').value.trim();
var genRes=await fetch('/api/generate',{method:'POST',headers:authHeaders,body:JSON.stringify({audioUrl:uploadData.blobUrl,duration:G.time,instrumental:G.instrumental,prompt:prompt})});
var genData=await genRes.json();

if(genData.success&&genData.taskId){taskId=genData.taskId;}
else{console.log('Generate error:',genData);taskId=null;}
}catch(e){console.log('Error:',e);taskId=null;}

if(taskId){
_genActive=true;
G.recordingUrl=uploadData.blobUrl;
localStorage.setItem('humusic_taskId',taskId);
localStorage.setItem('humusic_taskTime',Date.now().toString());
localStorage.setItem('humusic_recordingUrl',uploadData.blobUrl);
pollStatus(taskId);
}
else{showError('ê³¡ ìƒì„± ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');}
}

function pollStatus(taskId){
if(_pollIv){clearInterval(_pollIv);_pollIv=null;}
var p=5,pollCount=0,maxPolls=100,done=false;
setProgress(p,'ì„œë²„ì— ìš”ì²­ì„ ë³´ëƒˆì–´ìš”...');
_pollIv=setInterval(async function(){
if(done)return;
pollCount++;
if(pollCount>maxPolls){clearInterval(_pollIv);_pollIv=null;clearGenState();showError('ê³¡ ìƒì„± ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');return;}
try{
var ah=await getAuthHeaders();
var r=await fetch('/api/status?taskId='+taskId,{headers:ah});
var d=await r.json();
if(d.status==='completed'&&d.song){
if(done)return;
done=true;clearInterval(_pollIv);_pollIv=null;
var recUrl=G.recordingUrl||localStorage.getItem('humusic_recordingUrl')||'';
clearGenState();setProgress(100,'ì™„ì„±!');
var song={title:d.song.title||'ë‚˜ì˜ ë…¸ë˜',audioUrl:d.song.audioUrl||'',imageUrl:d.song.imageUrl||'',lyrics:d.song.lyrics||'',recordingUrl:recUrl};
await saveSong(song);
setTimeout(function(){goLib();},500);
}else if(d.status==='failed'){clearInterval(_pollIv);_pollIv=null;clearGenState();showError(d.error||'ê³¡ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');}
else{
var serverP=d.progress||0;
p=serverP>p?serverP:Math.min(90,p+2);
var msg=p<20?'AIê°€ ë©œë¡œë””ë¥¼ ë¶„ì„í•˜ê³  ìˆì–´ìš”...':p<50?'ê°€ì‚¬ë¥¼ ìƒì„±í•˜ê³  ìˆì–´ìš”...':p<80?'ë°˜ì£¼ë¥¼ ì™„ì„±í•˜ê³  ìˆì–´ìš”...':'ìµœì¢… ë¯¹ì‹± ì¤‘...';
setProgress(p,msg);}
}catch(e){clearInterval(_pollIv);_pollIv=null;clearGenState();showError('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');}
},3000);
}

function clearGenState(){
_genActive=false;_submitting=false;
if(_pollIv){clearInterval(_pollIv);_pollIv=null;}
localStorage.removeItem('humusic_taskId');
localStorage.removeItem('humusic_taskTime');
localStorage.removeItem('humusic_recordingUrl');
G.recordingUrl='';
}

function resumeGenIfNeeded(){
if(_pollIv)return true;
var savedTaskId=localStorage.getItem('humusic_taskId');
var savedTime=localStorage.getItem('humusic_taskTime');
if(!savedTaskId)return false;
// 10ë¶„ ì´ìƒ ì§€ë‚œ ì‘ì—…ì€ ë§Œë£Œ ì²˜ë¦¬
if(savedTime&&(Date.now()-parseInt(savedTime))>600000){
clearGenState();return false;
}
_maxP=0;
_genActive=true;
show('s-gen');
document.getElementById('gen-style').textContent='ë©œë¡œë”” ê¸°ë°˜ AI ìë™ ì‘ê³¡';
document.getElementById('gen-bar').style.width='0%';
document.getElementById('gen-pct').textContent='í™•ì¸ ì¤‘...';
document.getElementById('gen-msg').textContent='ì´ì „ ì‘ì—…ì„ ì´ì–´ì„œ í™•ì¸í•˜ê³  ìˆì–´ìš”...';
pollStatus(savedTaskId);
return true;
}

function showError(msg){
clearGenState();
show('s-error');
document.getElementById('error-msg').textContent=msg||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
}

var _maxP=0;
function setProgress(p,msg){
p=Math.min(100,Math.round(p));
if(p<_maxP&&p<100)p=_maxP;
_maxP=p;
document.getElementById('gen-bar').style.width=p+'%';
document.getElementById('gen-pct').textContent=p+'%';
document.getElementById('gen-msg').textContent=msg||'';
}

// === DB ì €ì¥/ì¡°íšŒ ===
async function saveSong(song){
if(!G.user)return;
try{
await sb.from('songs').insert({
user_id:G.user.id,
title:song.title,
audio_url:song.audioUrl||null,
image_url:song.imageUrl||null,
lyrics:song.lyrics||null,
recording_url:song.recordingUrl||null
});
}catch(e){console.log('Save failed',e);}
}

async function loadLibrary(){
var list=document.getElementById('lib-list'),empty=document.getElementById('lib-empty');
if(!G.user){list.innerHTML='';empty.style.display='block';return;}
try{
var {data}=await sb.from('songs').select('*').eq('user_id',G.user.id).order('created_at',{ascending:false});
if(!data||data.length===0){list.innerHTML='';empty.style.display='block';document.getElementById('lib-count').textContent='0ê³¡';return;}
G.songs=data.map(dbToSong);
document.getElementById('lib-count').textContent=G.songs.length+'ê³¡';
empty.style.display='none';
list.innerHTML=G.songs.map(function(s,i){
var d=new Date(s.createdAt);
var ds=(d.getMonth()+1)+'/'+(d.getDate())+' '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
var thumb=s.imageUrl?'background:url('+s.imageUrl+') center/cover;':'';
var heart=heartSvg(s.liked);
return '<div class="card" style="display:flex;align-items:center;gap:10px;cursor:pointer" onclick="showResult(G.songs['+i+'],\'library\')"><button id="heart-'+i+'" onclick="event.stopPropagation();toggleLike('+i+')" style="flex-shrink:0;background:transparent;padding:0;width:20px;display:flex;align-items:center;justify-content:center">'+heart+'</button><div style="width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;'+thumb+'" class="'+(s.imageUrl?'':'gradient')+'">'+(!s.imageUrl?'â–¶':'')+'</div><div style="flex:1;min-width:0"><b style="font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:block">'+s.title+'</b><span class="muted" style="font-size:11px">'+ds+'</span></div><button onclick="event.stopPropagation();confirmDelete('+i+',event)" style="width:32px;height:32px;display:flex;align-items:center;justify-content:center;flex-shrink:0;border-radius:50%;background:transparent;color:rgba(255,255,255,0.3);font-size:18px;letter-spacing:2px">â‹®</button></div>';
}).join('');
}catch(e){list.innerHTML='';empty.style.display='block';}
}

function heartSvg(filled){
return filled?'<svg width="16" height="16" viewBox="0 0 24 24" fill="#e74c3c" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="1.5" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>';
}

async function toggleLike(idx){
var song=G.songs[idx];if(!song||!song.id)return;
song.liked=!song.liked;
var btn=document.getElementById('heart-'+idx);
if(btn)btn.innerHTML=heartSvg(song.liked);
try{await sb.from('songs').update({liked:song.liked}).eq('id',song.id).eq('user_id',G.user.id);}catch(e){song.liked=!song.liked;if(btn)btn.innerHTML=heartSvg(song.liked);}
}

var _deleteIdx=-1;
function confirmDelete(idx,ev){
_deleteIdx=idx;
var btn=ev.target.closest('button');
var rect=btn.getBoundingClientRect();
var pop=document.getElementById('popover');
pop.style.display='block';
pop.style.top=(rect.bottom+4)+'px';
pop.style.right=(window.innerWidth-rect.right)+'px';
pop.style.left='auto';
document.getElementById('popover-bg').style.display='block';
}
function closePopover(){
document.getElementById('popover').style.display='none';
document.getElementById('popover-bg').style.display='none';
_deleteIdx=-1;
}
function doRename(){
var idx=_deleteIdx;
closePopover();
if(idx<0||!G.songs[idx])return;
var modal=document.getElementById('rename-modal');
var input=document.getElementById('rename-input');
input.value=G.songs[idx].title;
modal.style.display='block';
document.getElementById('rename-bg').style.display='block';
modal._idx=idx;
setTimeout(function(){input.focus();input.select();},100);
}
function closeRename(){
document.getElementById('rename-modal').style.display='none';
document.getElementById('rename-bg').style.display='none';
}
async function submitRename(){
var modal=document.getElementById('rename-modal');
var idx=modal._idx;
var newName=document.getElementById('rename-input').value.trim();
if(!newName||idx<0||!G.songs[idx])return closeRename();
var song=G.songs[idx];
closeRename();
try{await sb.from('songs').update({title:newName}).eq('id',song.id).eq('user_id',G.user.id);}catch(e){}
loadLibrary();
}
function doDelete(){
if(_deleteIdx>=0)deleteSong(_deleteIdx);
closePopover();
}

async function deleteSong(idx){
var song=G.songs[idx];if(!song||!song.id)return;
try{
await sb.from('songs').delete().eq('id',song.id).eq('user_id',G.user.id);
if(G.currentSong&&G.currentSong.id===song.id){G.currentSong=null;document.getElementById('mini-player').style.display='none';document.getElementById('player').pause();}
loadLibrary();
}catch(e){console.log('Delete failed',e);}
}

function dbToSong(row){
return {id:row.id,title:row.title,audioUrl:row.audio_url||'',imageUrl:row.image_url||'',lyrics:row.lyrics||'',createdAt:row.created_at,liked:!!row.liked,recordingUrl:row.recording_url||''};
}

// === ê²°ê³¼ í‘œì‹œ ===
function showResult(song,from){
G.currentSong=song;
G.resultFrom=from||'home';
show('s-result');
var backBtn=document.getElementById('result-back');
if(G.resultFrom==='library'){backBtn.textContent='â† ë³´ê´€í•¨';backBtn.onclick=function(){goLib();};}
else{backBtn.textContent='â† í™ˆ';backBtn.onclick=function(){goHome();};}
document.getElementById('song-title').textContent=song.title;
document.getElementById('song-info').textContent='';
var player=document.getElementById('player');
var noAudio=document.getElementById('no-audio');
var cp=document.getElementById('custom-player');
if(song.audioUrl){
player.src=song.audioUrl;player.load();
cp.style.display='block';noAudio.style.display='none';
document.getElementById('cp-icon').textContent='â–¶';
document.getElementById('cp-progress').style.width='0%';
document.getElementById('cp-cur').textContent='0:00';
document.getElementById('cp-dur').textContent='0:00';
// ë¯¸ë‹ˆ í”Œë ˆì´ì–´ ì„¸íŒ…
document.getElementById('mini-title').textContent=song.title;
if(song.imageUrl){document.getElementById('mini-thumb').style.background='url('+song.imageUrl+') center/cover';document.getElementById('mini-thumb').className='';document.getElementById('mini-thumb').innerHTML='';}
else{document.getElementById('mini-thumb').style.background='';document.getElementById('mini-thumb').className='gradient';document.getElementById('mini-thumb').innerHTML='ğŸ¶';}
}else{cp.style.display='none';noAudio.style.display='block';}
if(song.lyrics){document.getElementById('lyrics').textContent=song.lyrics;document.getElementById('lyrics-box').style.display='block';}
else{document.getElementById('lyrics-box').style.display='none';}
if(song.imageUrl){document.getElementById('album-art').style.background='url('+song.imageUrl+') center/cover';}
else{document.getElementById('album-art').style.background='';document.getElementById('album-art').className='gradient';document.getElementById('album-art').style.borderRadius='20px';}
// ë…¹ìŒ ì›ë³¸ í”Œë ˆì´ì–´
var recPlayer=document.getElementById('rec-audio');
var recBox=document.getElementById('rec-player');
if(song.recordingUrl){
recPlayer.src=song.recordingUrl;recPlayer.load();
recBox.style.display='block';
document.getElementById('rp-icon').textContent='â–¶';
document.getElementById('rp-progress').style.width='0%';
document.getElementById('rp-cur').textContent='0:00';
document.getElementById('rp-dur').textContent='0:00';
}else{recBox.style.display='none';}
}

function togglePlay(){
var player=document.getElementById('player');
if(player.paused){document.getElementById('rec-audio').pause();player.play();}else{player.pause();}
}
function seekTo(ev,audioEl,barEl){if(!audioEl.duration)return;var r=barEl.getBoundingClientRect();audioEl.currentTime=Math.max(0,Math.min(1,(ev.clientX-r.left)/r.width))*audioEl.duration;}
function seekAudio(ev){seekTo(ev,document.getElementById('player'),document.getElementById('cp-bar-wrap'));}
// === í”Œë ˆì´ì–´ ì´ë²¤íŠ¸ ===
(function(){
var player=document.getElementById('player');
function syncIcons(icon){document.getElementById('cp-icon').textContent=icon;document.getElementById('mini-play-icon').textContent=icon;}
player.addEventListener('play',function(){syncIcons('â¸');});
player.addEventListener('pause',function(){syncIcons('â–¶');});
player.addEventListener('ended',function(){
syncIcons('â–¶');
document.getElementById('cp-progress').style.width='0%';
document.getElementById('cp-cur').textContent='0:00';
document.getElementById('mini-progress').style.width='0%';
});
player.addEventListener('timeupdate',function(){
if(!player.duration)return;
var pct=player.currentTime/player.duration*100;
document.getElementById('cp-progress').style.width=pct+'%';
document.getElementById('cp-cur').textContent=fmtT(player.currentTime);
document.getElementById('mini-progress').style.width=pct+'%';
});
player.addEventListener('loadedmetadata',function(){
document.getElementById('cp-dur').textContent=fmtT(player.duration);
});
})();

// === ë…¹ìŒ ì›ë³¸ í”Œë ˆì´ì–´ ===
function toggleRecPlay(){
var rp=document.getElementById('rec-audio');
var mp=document.getElementById('player');
if(rp.paused){mp.pause();rp.play();}else{rp.pause();}
}
function seekRecAudio(ev){seekTo(ev,document.getElementById('rec-audio'),document.getElementById('rp-bar-wrap'));}
(function(){
var rp=document.getElementById('rec-audio');
rp.addEventListener('play',function(){document.getElementById('rp-icon').textContent='â¸';});
rp.addEventListener('pause',function(){document.getElementById('rp-icon').textContent='â–¶';});
rp.addEventListener('ended',function(){
document.getElementById('rp-icon').textContent='â–¶';
document.getElementById('rp-progress').style.width='0%';
document.getElementById('rp-cur').textContent='0:00';
});
rp.addEventListener('timeupdate',function(){
if(!rp.duration)return;
document.getElementById('rp-progress').style.width=(rp.currentTime/rp.duration*100)+'%';
document.getElementById('rp-cur').textContent=fmtT(rp.currentTime);
});
rp.addEventListener('loadedmetadata',function(){
document.getElementById('rp-dur').textContent=fmtT(rp.duration);
});
})();

// === ì¸ì•± ë¸Œë¼ìš°ì € ê°ì§€ ===
function isInAppBrowser(){
var ua=navigator.userAgent||'';
return /KAKAOTALK|NAVER|Instagram|FBAN|FBAV|Line\/|Twitter|Snapchat|WhatsApp|Daum|everytimeApp|wv\)/i.test(ua);
}
function openExternal(){
var url=location.href;
if(/android/i.test(navigator.userAgent)){
location.href='intent://'+url.replace(/https?:\/\//,'')+'#Intent;scheme=https;package=com.android.chrome;end';
setTimeout(function(){location.href='googlechrome://navigate?url='+encodeURIComponent(url);},500);
}else{
location.href=url;
}
}
function copyLink(){
navigator.clipboard.writeText(location.href).then(function(){
document.getElementById('copy-btn').textContent='ë³µì‚¬ ì™„ë£Œ!';
setTimeout(function(){document.getElementById('copy-btn').textContent='ë§í¬ ë³µì‚¬í•˜ê¸°';},2000);
}).catch(function(){
prompt('ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:',location.href);
});
}
if(isInAppBrowser()){document.getElementById('inapp-warn').style.display='block';}

// === ì´ˆê¸°í™” ===
checkAuth();
</script>
</body>
</html>
