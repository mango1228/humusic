<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#06060C">
<title>Humusic</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#06060C;color:#eee;font-family:-apple-system,sans-serif;max-width:420px;margin:0 auto;min-height:100vh;overflow-x:hidden}
button{border:none;background:none;color:#eee;font-family:inherit;cursor:pointer;-webkit-tap-highlight-color:transparent}
.screen{display:none;padding:20px;padding-top:50px;min-height:100vh}
.screen.active{display:block}
.gradient{background:linear-gradient(135deg,#FF6B4A,#FF3CAC,#845EF7)}
.btn{padding:14px 36px;border-radius:99px;font-size:15px;font-weight:700;color:#fff}
.pill{padding:8px 16px;border-radius:99px;font-size:13px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.03);margin:4px;display:inline-block}
.pill.on{border-color:#FF6B4A;background:rgba(255,107,74,0.15)}
.card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:14px;padding:14px;margin-bottom:10px}
.dim{color:rgba(255,255,255,0.4)}
.muted{color:rgba(255,255,255,0.2)}
.nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:420px;background:rgba(6,6,12,0.95);border-top:1px solid rgba(255,255,255,0.06);display:flex;justify-content:space-around;padding:10px 0 16px;z-index:100}
.nav button{font-size:10px;display:flex;flex-direction:column;align-items:center;gap:4px}
.rec-btn{width:72px;height:72px;border-radius:50%;border:3px solid rgba(255,255,255,0.15);display:flex;align-items:center;justify-content:center}
.rec-btn .dot{width:26px;height:26px;border-radius:50%;background:#fff}
.rec-btn .stop{width:22px;height:22px;border-radius:4px;background:#fff}
canvas{width:100%;height:100px;display:block}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
h1{font-size:28px;font-weight:900;background:linear-gradient(135deg,#FF6B4A,#FF3CAC,#845EF7);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
audio{width:100%;height:48px;border-radius:12px;color-scheme:dark}
audio::-webkit-media-controls-panel{background:rgba(255,255,255,0.06)}
.play-btn{width:100%;padding:14px;border-radius:14px;font-size:15px;font-weight:700;color:#fff;text-align:center;display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer}
.google-btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:14px 32px;border-radius:99px;font-size:15px;font-weight:600;background:#fff;color:#333;box-shadow:0 4px 16px rgba(0,0,0,0.3)}
.user-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.user-info{display:flex;align-items:center;gap:10px}
.user-avatar{width:32px;height:32px;border-radius:50%;border:2px solid rgba(255,107,74,0.3)}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="s-login" class="screen active">
<div style="text-align:center;padding-top:25vh">
<div style="font-size:64px;margin-bottom:20px">ğŸ¤</div>
<h1 style="font-size:32px;margin-bottom:8px">Humusic</h1>
<p class="dim" style="font-size:14px;margin-bottom:40px;line-height:1.6">í¥ì–¼ê±°ë¦¼ì„ AIê°€<br>ìŒì•…ìœ¼ë¡œ ë§Œë“¤ì–´ë“œë ¤ìš”</p>
<div id="inapp-warn" style="display:none;background:rgba(255,107,74,0.1);border:1px solid rgba(255,107,74,0.2);border-radius:14px;padding:16px;margin-bottom:20px;text-align:left">
<p style="font-size:14px;font-weight:700;margin-bottom:6px">ì™¸ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ì–´ì£¼ì„¸ìš”</p>
<p class="dim" style="font-size:12px;line-height:1.6;margin-bottom:10px">ì¹´ì¹´ì˜¤í†¡Â·ì¸ìŠ¤íƒ€ê·¸ë¨ ë“± ì¸ì•± ë¸Œë¼ìš°ì €ì—ì„œëŠ”<br>Google ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ë¡œê·¸ì¸ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.</p>
<button onclick="openExternal()" style="width:100%;padding:12px;border-radius:10px;font-size:14px;font-weight:700;color:#fff;margin-bottom:8px" class="gradient">Chrome/Safarië¡œ ì—´ê¸°</button>
<button onclick="copyLink()" id="copy-btn" style="width:100%;padding:10px;border-radius:10px;font-size:13px;color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1)">ë§í¬ ë³µì‚¬í•˜ê¸°</button>
</div>
<button class="google-btn" onclick="signIn()">
<svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
Googleë¡œ ì‹œì‘í•˜ê¸°
</button>
</div>
</div>

<!-- HOME -->
<div id="s-home" class="screen">
<div class="user-bar">
<div>
<p class="muted" style="font-size:11px;letter-spacing:2px;margin-bottom:4px">YOUR MUSIC STUDIO</p>
<h1>Humusic</h1>
</div>
<div class="user-info">
<img id="user-avatar" class="user-avatar" src="" alt="">
<button class="dim" style="font-size:11px" onclick="signOut()">ë¡œê·¸ì•„ì›ƒ</button>
</div>
</div>
<div style="text-align:center;padding:30px 0;border-radius:20px;margin-top:8px;background:linear-gradient(160deg,rgba(255,107,74,0.1),rgba(132,94,247,0.05));border:1px solid rgba(255,107,74,0.1)">
<div style="font-size:48px;margin-bottom:12px">ğŸ¤</div>
<h2 style="font-size:18px;font-weight:700;line-height:1.5;margin-bottom:6px">í¥ì–¼ê±°ë¦¼ì„<br>ìŒì•…ìœ¼ë¡œ ë§Œë“¤ì–´ë³´ì„¸ìš”</h2>
<p class="dim" style="font-size:13px;margin-bottom:20px">ì½§ë…¸ë˜ë¥¼ ë…¹ìŒí•˜ë©´ AIê°€<br>ì™„ì„±ëœ ê³¡ìœ¼ë¡œ ë§Œë“¤ì–´ë“œë ¤ìš”</p>
<button class="btn gradient" onclick="goRecord()" style="box-shadow:0 6px 24px rgba(255,107,74,0.3)">ë…¹ìŒ ì‹œì‘í•˜ê¸°</button>
</div>
<div id="recent" style="margin-top:24px;display:none">
<p class="muted" style="font-size:11px;letter-spacing:2px;margin-bottom:12px">ìµœê·¼ ë§Œë“  ê³¡</p>
<div id="recent-list"></div>
</div>
<div style="height:80px"></div>
</div>

<!-- RECORDING -->
<div id="s-record" class="screen">
<div style="display:flex;justify-content:space-between;align-items:center">
<button class="dim" onclick="goHome()">â† ë’¤ë¡œ</button>
<span class="muted" style="font-size:12px;letter-spacing:1px">ë…¹ìŒ</span>
<div style="width:40px"></div>
</div>
<div style="text-align:center;margin-top:24px">
<div id="timer" style="font-size:52px;font-weight:300;letter-spacing:6px">0:00</div>
<div id="rec-status" class="muted" style="font-size:12px;margin-top:6px">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”</div>
<div id="sim-badge" class="card" style="display:none;margin-top:10px;background:rgba(132,94,247,0.1);border-color:rgba(132,94,247,0.15)">
<span style="color:#845EF7;font-size:12px;font-weight:600">ğŸµ ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ</span><br>
<span class="dim" style="font-size:11px">ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</span>
</div>
</div>
<div class="card" style="margin-top:16px;padding:16px"><canvas id="wave"></canvas></div>
<p class="dim" style="font-size:12px;text-align:center;margin-top:16px;line-height:1.6">AIê°€ ë©œë¡œë””ë¥¼ ë“£ê³ <br>ì¥ë¥´ì™€ ë¶„ìœ„ê¸°ë¥¼ ìë™ìœ¼ë¡œ ë§ì¶°ë“œë ¤ìš”</p>
<div style="display:flex;justify-content:center;align-items:center;gap:24px;padding:20px 0">
<button id="btn-reset" onclick="resetRec()" style="display:none;width:48px;height:48px;border-radius:50%;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);font-size:20px">â†º</button>
<button id="btn-rec" class="rec-btn gradient" onclick="toggleRec()"><div class="dot"></div></button>
<button id="btn-next" onclick="submitGen()" style="display:none;width:48px;height:48px;border-radius:50%;font-size:18px" class="gradient">â†’</button>
</div>
</div>

<!-- GENERATING -->
<div id="s-gen" class="screen" style="text-align:center;padding-top:30vh">
<div style="width:80px;height:80px;border-radius:50%;border:3px solid rgba(255,255,255,0.06);border-top-color:#FF6B4A;animation:spin 1s linear infinite;margin:0 auto 24px"></div>
<h2 style="font-size:18px;font-weight:700;margin-bottom:8px">AIê°€ ê³¡ì„ ë§Œë“¤ê³  ìˆì–´ìš”</h2>
<p id="gen-style" class="dim" style="font-size:13px;margin-bottom:6px"></p>
<p id="gen-msg" style="color:#FF6B4A;font-size:12px;animation:pulse 2s infinite;margin-bottom:16px"></p>
<div style="width:240px;height:5px;border-radius:99px;background:rgba(255,255,255,0.03);margin:0 auto;overflow:hidden">
<div id="gen-bar" style="width:0%;height:100%;border-radius:99px;transition:width .3s" class="gradient"></div>
</div>
<span id="gen-pct" class="muted" style="font-size:12px;margin-top:8px;display:block">0%</span>
<p class="dim" style="font-size:11px;margin-top:20px;line-height:1.6">ë³´í†µ 1~3ë¶„ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤<br>í™”ë©´ì„ ë‹«ì§€ ë§ˆì„¸ìš”</p>
</div>

<!-- ERROR -->
<div id="s-error" class="screen" style="text-align:center;padding-top:25vh">
<div style="font-size:56px;margin-bottom:16px">ğŸ˜”</div>
<h2 style="font-size:18px;font-weight:700;margin-bottom:8px">ê³¡ ìƒì„±ì— ì‹¤íŒ¨í–ˆì–´ìš”</h2>
<p id="error-msg" class="dim" style="font-size:13px;line-height:1.6;margin-bottom:24px"></p>
<button class="btn gradient" onclick="goRecord()" style="box-shadow:0 6px 24px rgba(255,107,74,0.3)">ë‹¤ì‹œ ë…¹ìŒí•˜ê¸°</button>
<button class="dim" onclick="goHome()" style="display:block;margin:12px auto;font-size:13px">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<!-- RESULT -->
<div id="s-result" class="screen">
<div style="display:flex;justify-content:space-between;align-items:center">
<button class="dim" onclick="goHome()">â† í™ˆ</button>
<span class="muted" style="font-size:12px;letter-spacing:1px">ì™„ì„±</span>
<div style="width:40px"></div>
</div>
<div style="text-align:center;margin-top:16px">
<div id="album-art" style="width:200px;height:200px;border-radius:20px;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;font-size:56px;box-shadow:0 12px 40px rgba(255,60,172,0.15)" class="gradient">ğŸ¶</div>
<h2 id="song-title" style="font-size:20px;font-weight:700"></h2>
<p id="song-info" class="dim" style="font-size:13px;margin-top:4px"></p>
</div>
<div style="margin-top:16px">
<button id="play-btn" class="play-btn gradient" onclick="togglePlay()" style="display:none;box-shadow:0 6px 24px rgba(255,107,74,0.3)">
<span id="play-icon" style="font-size:20px">â–¶</span>
<span id="play-text">ì¬ìƒí•˜ê¸°</span>
</button>
<audio id="player" style="margin-top:8px;margin-bottom:8px" controls></audio>
<div id="no-audio" class="dim" style="text-align:center;font-size:12px;display:none">ë°ëª¨ ëª¨ë“œ - ì‹¤ì œ ë°°í¬ ì‹œ ì¬ìƒ ê°€ëŠ¥</div>
</div>
<div id="lyrics-box" style="margin-top:20px;display:none">
<p class="muted" style="font-size:11px;letter-spacing:1.5px;margin-bottom:8px">ê°€ì‚¬</p>
<div class="card"><p id="lyrics" style="color:rgba(255,255,255,0.55);font-size:13px;line-height:2;white-space:pre-line;font-style:italic"></p></div>
</div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="card" style="flex:1;text-align:center;font-size:13px;font-weight:600" onclick="goRecord()">ğŸ”„ ë‹¤ì‹œ ë§Œë“¤ê¸°</button>
</div>
<div style="height:80px"></div>
</div>

<!-- LIBRARY -->
<div id="s-library" class="screen">
<h1 style="font-size:24px">ë‚´ ë³´ê´€í•¨</h1>
<p class="dim" style="font-size:13px;margin-top:4px" id="lib-count">0ê³¡</p>
<div id="lib-list" style="margin-top:16px"></div>
<div id="lib-empty" style="text-align:center;padding:60px 0">
<div style="font-size:48px;margin-bottom:12px">ğŸµ</div>
<p class="dim">ì•„ì§ ë§Œë“  ê³¡ì´ ì—†ì–´ìš”</p>
<button class="btn gradient" onclick="goRecord()" style="margin-top:16px">ì²« ê³¡ ë§Œë“¤ëŸ¬ ê°€ê¸°</button>
</div>
<div style="height:80px"></div>
</div>

<!-- NAV -->
<div class="nav" id="navbar" style="display:none">
<button onclick="goHome()"><span>ğŸ </span><span>í™ˆ</span></button>
<button onclick="goLib()"><span>ğŸµ</span><span>ë³´ê´€í•¨</span></button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Supabase ì´ˆê¸°í™”
var SUPABASE_URL='https://xjuzejvrzhzwjcwcmgmv.supabase.co';
var SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqdXplanZyemh6d2pjd2NtZ212Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MzkyOTcsImV4cCI6MjA4NjUxNTI5N30.cMJGmuIZ7_LsBvHcmqxOmkWoPx1jCrAp4_W4CYg8_uE';
var sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

var G={recording:false,simMode:false,time:0,songs:[],user:null,melodyData:null},
mediaRec,audioCtx,analyser,stream,chunks=[],timerIv,canvasAnim,pitchHistory=[],energyHistory=[],
GENRES=[{id:"pop",l:"Pop",e:"ğŸµ"},{id:"rnb",l:"R&B",e:"ğŸ’œ"},{id:"hiphop",l:"Hip-Hop",e:"ğŸ”¥"},{id:"ballad",l:"Ballad",e:"ğŸŒ™"},{id:"rock",l:"Rock",e:"ğŸ¸"},{id:"jazz",l:"Jazz",e:"ğŸ·"},{id:"electronic",l:"Electronic",e:"âš¡"},{id:"indie",l:"Indie",e:"ğŸŒ¿"}],
MOODS=[{id:"chill",l:"í¸ì•ˆí•œ",e:"ğŸ˜Œ"},{id:"energetic",l:"ì‹ ë‚˜ëŠ”",e:"ğŸ’ƒ"},{id:"melancholy",l:"ê°ì„±ì ì¸",e:"ğŸŒ§"},{id:"romantic",l:"ë¡œë§¨í‹±",e:"ğŸ’•"},{id:"epic",l:"ì›…ì¥í•œ",e:"ğŸ”"},{id:"dreamy",l:"ëª½í™˜ì ì¸",e:"â˜ï¸"}],
TITLES={pop:"ë°¤í•˜ëŠ˜ ì•„ë˜ì„œ",rnb:"Sunday Groove",hiphop:"My Anthem",ballad:"ë¹—ì†Œë¦¬ í¸ì§€",rock:"Burning Road",jazz:"Midnight Sax",electronic:"ë„¤ì˜¨ ì‹œí‹°",indie:"í’€ë°­ ìœ„ ì˜¤í›„"},
LYRICS={pop:"ë°¤í•˜ëŠ˜ ì•„ë˜ ê±¸ì–´ê°€ëŠ” ì´ ê¸¸\në„ˆì™€ ë‚˜ ì‚¬ì´ íë¥´ëŠ” melody\ní¥ì–¼ê±°ë¦¬ë˜ ê·¸ ë…¸ë˜ê°€\nì˜¤ëŠ˜ ë°¤ ìš°ë¦¬ì˜ ì´ì•¼ê¸°ê°€ ë¼\n\në¼ë¼ë¼ ë¶ˆëŸ¬ë´ ì´ ë…¸ë˜ë¥¼\nì„¸ìƒì´ ë©ˆì¶˜ ê²ƒì²˜ëŸ¼\nìš°ë¦¬ ë‘˜ë§Œì˜ ì‹œê°„ ì†ì—\nì˜ì›íˆ í•¨ê»˜ ì¶¤ì„ ì¶°",ballad:"ì°½ë°–ì— ë¹„ê°€ ë‚´ë¦¬ëŠ” ë‚ \në„ˆë¥¼ ë– ì˜¬ë¦¬ë©° í¥ì–¼ê±°ë ¤\nìŠí˜€ì§ˆ ì¤„ ì•Œì•˜ë˜ ë©œë¡œë””ê°€\në‹¤ì‹œ ë‚´ ê°€ìŠ´ì„ ì ì…”\n\në³´ê³  ì‹¶ë‹¤ ë§í•˜ê³  ì‹¶ì–´\nì´ ë…¸ë˜ì— ë‹´ì•„ì„œ\në°”ëŒì— ì‹¤ë ¤ ë„ˆì—ê²Œ\në‚´ ë§ˆìŒì´ ë‹¿ê¸°ë¥¼",hiphop:"Yo ë¨¸ë¦¿ì† ë©œë¡œë”” í„°ì ¸ ë‚˜ì™€\në¹„íŠ¸ ìœ„ì— ì˜¬ë ¤ ë´ ë‚´ ì´ì•¼ê¸°\nê¸¸ê±°ë¦¬ ìœ„ í¥ì–¼ê±°ë¦¼ì´\nì„¸ìƒì„ ë’¤í”ë“¤ anthemì´ ë¼",rnb:"ë‹¬ë¹›ì´ ë‚´ë ¤ì•‰ì€ ì´ ë°¤\në„ˆì˜ ëª©ì†Œë¦¬ê°€ ë‚  ê°ì‹¸ê³ \në¶€ë“œëŸ¬ìš´ ë°”ëŒì²˜ëŸ¼\në‚´ ê³ì— ë¨¸ë¬¼ëŸ¬ì¤˜"};

// === ì¸ì¦ ===
async function signIn(){
sb.auth.signInWithOAuth({provider:'google',options:{redirectTo:window.location.origin}});
}

async function signOut(){
await sb.auth.signOut();
G.user=null;G.songs=[];
show('s-login');
document.getElementById('navbar').style.display='none';
}

async function checkAuth(){
var {data:{session}}=await sb.auth.getSession();
if(session&&session.user){
G.user=session.user;
showLoggedIn();
}else{
show('s-login');
document.getElementById('navbar').style.display='none';
}
}

function showLoggedIn(){
var avatar=G.user.user_metadata.avatar_url||'';
if(avatar)document.getElementById('user-avatar').src=avatar;
document.getElementById('user-avatar').style.display=avatar?'block':'none';
goHome();
}

sb.auth.onAuthStateChange(function(event,session){
if(event==='SIGNED_IN'&&session){G.user=session.user;showLoggedIn();}
if(event==='SIGNED_OUT'){G.user=null;show('s-login');document.getElementById('navbar').style.display='none';}
});

// === ë„¤ë¹„ê²Œì´ì…˜ ===
function show(id){document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active')});document.getElementById(id).classList.add('active');document.getElementById('navbar').style.display=(id==='s-home'||id==='s-library')?'flex':'none';}
function fmtT(s){return Math.floor(s/60)+':'+String(s%60).padStart(2,'0');}
function goHome(){show('s-home');loadRecent();}
function goRecord(){G.time=0;G.simMode=false;show('s-record');updateRecUI();}
function goLib(){show('s-library');loadLibrary();}

// === ë…¹ìŒ UI ===
function updateRecUI(){
document.getElementById('timer').textContent=fmtT(G.time);
document.getElementById('rec-status').textContent=G.recording?'â— ë…¹ìŒ ì¤‘...':G.time>0?'ë…¹ìŒ ì™„ë£Œ':'ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”';
document.getElementById('rec-status').style.color=G.recording?'#FF6B4A':'rgba(255,255,255,0.2)';
document.getElementById('sim-badge').style.display=G.simMode&&G.recording?'block':'none';
document.getElementById('btn-reset').style.display=G.time>0&&!G.recording?'block':'none';
document.getElementById('btn-next').style.display=G.time>=3&&!G.recording?'block':'none';
var b=document.getElementById('btn-rec');
b.style.background=G.recording?'rgba(231,76,60,0.9)':'';
b.className=G.recording?'rec-btn':'rec-btn gradient';
b.innerHTML=G.recording?'<div class="stop"></div>':'<div class="dot"></div>';
}

function resetRec(){G.time=0;G.simMode=false;updateRecUI();}

async function toggleRec(){
if(G.recording){clearInterval(timerIv);G.recording=false;
if(!G.simMode)G.melodyData=analyzeMelody();
if(!G.simMode&&mediaRec&&mediaRec.state!=='inactive')mediaRec.stop();
if(stream)stream.getTracks().forEach(function(t){t.stop()});
if(audioCtx)audioCtx.close().catch(function(){});
updateRecUI();return;}
try{
stream=await navigator.mediaDevices.getUserMedia({audio:true});
audioCtx=new(window.AudioContext||window.webkitAudioContext)();
var src=audioCtx.createMediaStreamSource(stream);
analyser=audioCtx.createAnalyser();analyser.fftSize=256;src.connect(analyser);
mediaRec=new MediaRecorder(stream);chunks=[];
mediaRec.ondataavailable=function(e){if(e.data.size>0)chunks.push(e.data);};
mediaRec.start(100);G.simMode=false;pitchHistory=[];energyHistory=[];
}catch(e){G.simMode=true;}
G.recording=true;G.time=0;
timerIv=setInterval(function(){G.time++;updateRecUI();},1000);
updateRecUI();drawWave();
}

function drawWave(){
var c=document.getElementById('wave');if(!c)return;
var ctx=c.getContext('2d'),dpr=window.devicePixelRatio||1;
c.width=c.offsetWidth*dpr;c.height=c.offsetHeight*dpr;ctx.scale(dpr,dpr);
var W=c.offsetWidth,H=c.offsetHeight,bars=40,bw=3,gap=(W-bars*bw)/(bars-1),data=new Uint8Array(128),t=0;
cancelAnimationFrame(canvasAnim);
function draw(){ctx.clearRect(0,0,W,H);
if(analyser&&G.recording&&!G.simMode){analyser.getByteFrequencyData(data);
if(Math.random()<0.15){var maxI=0,maxV=0,totalE=0;for(var j=0;j<data.length;j++){totalE+=data[j];if(data[j]>maxV){maxV=data[j];maxI=j;}}
if(maxV>30){var freq=maxI*audioCtx.sampleRate/analyser.fftSize;pitchHistory.push(freq);}
energyHistory.push(totalE/data.length);}}
t+=.06;
for(var i=0;i<bars;i++){var v;
if(G.simMode&&G.recording){v=.2+.4*Math.sin(t+i*.3)*Math.sin(t*.7+i*.15)+.15*Math.cos(t*1.3+i*.5);v=Math.max(.05,Math.min(1,v));}
else if(analyser&&G.recording){v=data[Math.floor(i*128/bars)]/255;}else{v=0;}
var h=Math.max(3,v*H*.85),x=i*(bw+gap),y=(H-h)/2;
var g=ctx.createLinearGradient(x,y,x,y+h);
g.addColorStop(0,'rgba(255,107,74,'+(0.3+v*0.7)+')');
g.addColorStop(1,'rgba(132,94,247,'+(0.3+v*0.7)+')');
ctx.fillStyle=g;ctx.beginPath();ctx.roundRect(x,y,bw,h,2);ctx.fill();}
canvasAnim=requestAnimationFrame(draw);}draw();
}

// === ë©œë¡œë”” ë¶„ì„ ===
function analyzeMelody(){
if(pitchHistory.length<5)return null;
var NOTES=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
function freqToNote(f){var n=12*Math.log2(f/440)+69;return{note:NOTES[Math.round(n)%12],octave:Math.floor(Math.round(n)/12)-1,midi:Math.round(n)};}
var avgFreq=pitchHistory.reduce(function(a,b){return a+b},0)/pitchHistory.length;
var minFreq=Math.min.apply(null,pitchHistory),maxFreq=Math.max.apply(null,pitchHistory);
var avgNote=freqToNote(avgFreq);
var range=freqToNote(maxFreq).midi-freqToNote(minFreq).midi;
var ups=0,downs=0;
for(var i=1;i<pitchHistory.length;i++){if(pitchHistory[i]>pitchHistory[i-1]*1.03)ups++;else if(pitchHistory[i]<pitchHistory[i-1]*0.97)downs++;}
var contour=ups>downs*1.5?'ascending':downs>ups*1.5?'descending':'flowing';
var avgE=energyHistory.length>0?energyHistory.reduce(function(a,b){return a+b},0)/energyHistory.length:50;
var dynamics=avgE>100?'powerful and loud':avgE>60?'moderate energy':'soft and gentle';
var tempo='medium tempo';
if(energyHistory.length>20){var peaks=0;for(var i=2;i<energyHistory.length-2;i++){if(energyHistory[i]>energyHistory[i-1]&&energyHistory[i]>energyHistory[i+1]&&energyHistory[i]>avgE*1.2)peaks++;}
var bpm=Math.round(peaks/(G.time/60)*4);
if(bpm>0)tempo=bpm>140?'fast tempo around '+bpm+' BPM':bpm>100?'moderate tempo around '+bpm+' BPM':'slow tempo around '+bpm+' BPM';}
return{key:avgNote.note,range:range,contour:contour,dynamics:dynamics,tempo:tempo};}

// === WebM â†’ WAV ë³€í™˜ ===
function convertToWav(blob){
return new Promise(function(resolve,reject){
var actx=new(window.AudioContext||window.webkitAudioContext)();
var reader=new FileReader();
reader.onloadend=function(){
actx.decodeAudioData(reader.result,function(buf){
var numCh=buf.numberOfChannels,rate=buf.sampleRate,len=buf.length;
var wavBuf=new ArrayBuffer(44+len*numCh*2);
var view=new DataView(wavBuf);
function writeStr(o,s){for(var i=0;i<s.length;i++)view.setUint8(o+i,s.charCodeAt(i));}
writeStr(0,'RIFF');view.setUint32(4,36+len*numCh*2,true);writeStr(8,'WAVE');
writeStr(12,'fmt ');view.setUint32(16,16,true);view.setUint16(20,1,true);
view.setUint16(22,numCh,true);view.setUint32(24,rate,true);
view.setUint32(28,rate*numCh*2,true);view.setUint16(32,numCh*2,true);
view.setUint16(34,16,true);writeStr(36,'data');view.setUint32(40,len*numCh*2,true);
var off=44;
for(var i=0;i<len;i++){for(var ch=0;ch<numCh;ch++){
var s=Math.max(-1,Math.min(1,buf.getChannelData(ch)[i]));
view.setInt16(off,s<0?s*0x8000:s*0x7FFF,true);off+=2;}}
actx.close();
resolve(new Blob([wavBuf],{type:'audio/wav'}));
},function(e){actx.close();reject(e);});
};
reader.onerror=reject;
reader.readAsArrayBuffer(blob);
});
}

// === ê³¡ ìƒì„± ===
async function submitGen(){
if(G.time<3)return;
show('s-gen');
document.getElementById('gen-style').textContent='ë©œë¡œë”” ê¸°ë°˜ AI ìë™ ì‘ê³¡';
document.getElementById('gen-bar').style.width='0%';
document.getElementById('gen-pct').textContent='0%';

// ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ (ë§ˆì´í¬ ì—†ìŒ) â†’ ì—ëŸ¬
if(G.simMode||chunks.length===0){
showError('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ì ‘ê·¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
return;
}

var taskId=null;

// Step 1: WebM â†’ WAV ë³€í™˜ í›„ ì—…ë¡œë“œ
setProgress(5,'ì˜¤ë””ì˜¤ë¥¼ ë³€í™˜í•˜ê³  ìˆì–´ìš”...');
try{
var webmBlob=new Blob(chunks,{type:'audio/webm'});
var wavBlob=await convertToWav(webmBlob);
setProgress(8,'ë…¹ìŒëœ ì˜¤ë””ì˜¤ë¥¼ ì—…ë¡œë“œ ì¤‘...');
var base64=await new Promise(function(resolve,reject){
var reader=new FileReader();
reader.onloadend=function(){resolve(reader.result.split(',')[1]);};
reader.onerror=reject;
reader.readAsDataURL(wavBlob);
});

var uploadRes=await fetch('/api/upload-audio',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({audioBase64:base64})});
var uploadData=await uploadRes.json();

if(!uploadData.success||!uploadData.blobUrl){
console.log('Upload failed:',uploadData);
showError('ì˜¤ë””ì˜¤ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
return;
}

// Step 2: sunoapi.org upload-extend
setProgress(15,'AIì—ê²Œ ê³¡ ìƒì„±ì„ ìš”ì²­ ì¤‘...');
var genRes=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({audioUrl:uploadData.blobUrl,duration:G.time})});
var genData=await genRes.json();

if(genData.success&&genData.taskId){taskId=genData.taskId;}
else{console.log('Generate error:',genData);taskId=null;}
}catch(e){console.log('Error:',e);taskId=null;}

if(taskId){pollStatus(taskId);}
else{showError('ê³¡ ìƒì„± ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');}
}

function pollStatus(taskId){
var p=5;setProgress(p,'ì„œë²„ì— ìš”ì²­ì„ ë³´ëƒˆì–´ìš”...');
var iv=setInterval(async function(){
try{
var r=await fetch('/api/status?taskId='+taskId);
var d=await r.json();
if(d.status==='completed'&&d.song){
clearInterval(iv);setProgress(100,'ì™„ì„±!');
var song={title:d.song.title||'ë‚˜ì˜ ë…¸ë˜',audioUrl:d.song.audioUrl||'',imageUrl:d.song.imageUrl||'',lyrics:d.song.lyrics||''};
await saveSong(song);
setTimeout(function(){showResult(song);},500);
}else if(d.status==='failed'){clearInterval(iv);showError(d.error||'ê³¡ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');}
else{
var serverP=d.progress||0;
p=serverP>p?serverP:Math.min(90,p+2);
var msg=p<20?'AIê°€ ë©œë¡œë””ë¥¼ ë¶„ì„í•˜ê³  ìˆì–´ìš”...':p<50?'ê°€ì‚¬ë¥¼ ìƒì„±í•˜ê³  ìˆì–´ìš”...':p<80?'ë°˜ì£¼ë¥¼ ì™„ì„±í•˜ê³  ìˆì–´ìš”...':'ìµœì¢… ë¯¹ì‹± ì¤‘...';
setProgress(p,msg);}
}catch(e){clearInterval(iv);showError('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');}
},3000);
}

function showError(msg){
show('s-error');
document.getElementById('error-msg').textContent=msg||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
}

function setProgress(p,msg){
p=Math.min(100,Math.round(p));
document.getElementById('gen-bar').style.width=p+'%';
document.getElementById('gen-pct').textContent=p+'%';
document.getElementById('gen-msg').textContent=msg||'';
}

// === DB ì €ì¥/ì¡°íšŒ ===
async function saveSong(song){
if(!G.user)return;
try{
await sb.from('songs').insert({
user_id:G.user.id,
title:song.title,
audio_url:song.audioUrl||null,
image_url:song.imageUrl||null,
lyrics:song.lyrics||null,
genre:song.genre||null,
mood:song.mood||null,
is_demo:song.isDemo||false
});
}catch(e){console.log('Save failed',e);}
}

async function loadRecent(){
var box=document.getElementById('recent'),list=document.getElementById('recent-list');
if(!G.user){box.style.display='none';return;}
try{
var {data}=await sb.from('songs').select('*').eq('user_id',G.user.id).order('created_at',{ascending:false}).limit(3);
if(!data||data.length===0){box.style.display='none';return;}
box.style.display='block';
G.songs=data.map(dbToSong);
list.innerHTML=G.songs.slice(0,3).map(function(s,i){return songCard(s,i);}).join('');
}catch(e){box.style.display='none';}
}

async function loadLibrary(){
var list=document.getElementById('lib-list'),empty=document.getElementById('lib-empty');
if(!G.user){list.innerHTML='';empty.style.display='block';return;}
try{
var {data}=await sb.from('songs').select('*').eq('user_id',G.user.id).order('created_at',{ascending:false});
if(!data||data.length===0){list.innerHTML='';empty.style.display='block';document.getElementById('lib-count').textContent='0ê³¡';return;}
G.songs=data.map(dbToSong);
document.getElementById('lib-count').textContent=G.songs.length+'ê³¡';
empty.style.display='none';
list.innerHTML=G.songs.map(function(s,i){
var d=new Date(s.createdAt);
var ds=(d.getMonth()+1)+'ì›” '+d.getDate()+'ì¼';
var info=s.genreLabel&&s.moodLabel?s.genreLabel+' Â· '+s.moodLabel:'AI ì‘ê³¡';
return '<div class="card" style="display:flex;align-items:center;gap:12px;cursor:pointer" onclick="showResult(G.songs['+i+'])"><div style="width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0" class="gradient">â–¶</div><div style="flex:1;min-width:0"><b style="font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:block">'+s.title+'</b><span class="dim" style="font-size:12px">'+info+'</span></div><span class="muted" style="font-size:11px;flex-shrink:0">'+ds+'</span></div>';
}).join('');
}catch(e){list.innerHTML='';empty.style.display='block';}
}

function dbToSong(row){
var gl=GENRES.find(function(g){return g.id===row.genre}),ml=MOODS.find(function(m){return m.id===row.mood});
return {id:row.id,title:row.title,audioUrl:row.audio_url||'',imageUrl:row.image_url||'',lyrics:row.lyrics||'',genre:row.genre,mood:row.mood,genreLabel:gl?gl.l:'',moodLabel:ml?ml.l:'',isDemo:row.is_demo,createdAt:row.created_at};
}

function songCard(s,i){
var info=s.genreLabel&&s.moodLabel?s.genreLabel+' Â· '+s.moodLabel:'AI ì‘ê³¡';
return '<div class="card" style="display:flex;align-items:center;gap:12px;cursor:pointer" onclick="showResult(G.songs['+i+'])"><div style="width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0" class="gradient">â–¶</div><div><b style="font-size:14px">'+s.title+'</b><br><span class="dim" style="font-size:12px">'+info+'</span></div></div>';
}

// === ê²°ê³¼ í‘œì‹œ ===
function showResult(song){
show('s-result');
document.getElementById('song-title').textContent=song.title;
var infoText=song.genreLabel&&song.moodLabel?song.genreLabel+' Â· '+song.moodLabel:'AI ì‘ê³¡';
document.getElementById('song-info').textContent=infoText+(song.isDemo?' Â· Demo':'');
var player=document.getElementById('player');
var noAudio=document.getElementById('no-audio');
var playBtn=document.getElementById('play-btn');
if(song.audioUrl){
player.src=song.audioUrl;player.style.display='block';player.load();
playBtn.style.display='flex';noAudio.style.display='none';
player.onplay=function(){document.getElementById('play-icon').textContent='â¸';document.getElementById('play-text').textContent='ì¼ì‹œì •ì§€';};
player.onpause=function(){document.getElementById('play-icon').textContent='â–¶';document.getElementById('play-text').textContent='ì¬ìƒí•˜ê¸°';};
player.onended=function(){document.getElementById('play-icon').textContent='â–¶';document.getElementById('play-text').textContent='ë‹¤ì‹œ ì¬ìƒ';};
}else{player.style.display='none';playBtn.style.display='none';noAudio.style.display='block';noAudio.innerHTML=song.isDemo?'ğŸµ ë°ëª¨ ë¯¸ë¦¬ë³´ê¸° - ê°€ì‚¬ì™€ ìŠ¤íƒ€ì¼ë§Œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤<br><span style="font-size:11px;margin-top:4px;display:block">ì‹¤ì œ ê³¡ ìƒì„±ì€ API í¬ë ˆë”§ì´ í•„ìš”í•©ë‹ˆë‹¤</span>':'â³ ì˜¤ë””ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';}
if(song.lyrics){document.getElementById('lyrics').textContent=song.lyrics;document.getElementById('lyrics-box').style.display='block';}
else{document.getElementById('lyrics-box').style.display='none';}
if(song.imageUrl){document.getElementById('album-art').style.background='url('+song.imageUrl+') center/cover';}
else{document.getElementById('album-art').style.background='';document.getElementById('album-art').className='gradient';document.getElementById('album-art').style.borderRadius='20px';}
}

function togglePlay(){
var player=document.getElementById('player');
if(player.paused){player.play();}else{player.pause();}
}

// === ì¸ì•± ë¸Œë¼ìš°ì € ê°ì§€ ===
function isInAppBrowser(){
var ua=navigator.userAgent||'';
return /KAKAOTALK|NAVER|Instagram|FBAN|FBAV|Line\/|Twitter|Snapchat|WhatsApp|Daum|everytimeApp|wv\)/i.test(ua);
}
function openExternal(){
var url=location.href;
if(/android/i.test(navigator.userAgent)){
location.href='intent://'+url.replace(/https?:\/\//,'')+'#Intent;scheme=https;package=com.android.chrome;end';
setTimeout(function(){location.href='googlechrome://navigate?url='+encodeURIComponent(url);},500);
}else{
location.href=url;
}
}
function copyLink(){
navigator.clipboard.writeText(location.href).then(function(){
document.getElementById('copy-btn').textContent='ë³µì‚¬ ì™„ë£Œ!';
setTimeout(function(){document.getElementById('copy-btn').textContent='ë§í¬ ë³µì‚¬í•˜ê¸°';},2000);
}).catch(function(){
prompt('ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:',location.href);
});
}
if(isInAppBrowser()){document.getElementById('inapp-warn').style.display='block';}

// === ì´ˆê¸°í™” ===
checkAuth();
</script>
</body>
</html>
